---
- name: Include OS-Specific variables
  include_vars: "{{ ansible_os_family }}.yml"

- name: Define clamav_daemon.
  set_fact:
    clamav_daemon: "{{ __clamav_daemon }}"
  when: clamav_daemon is not defined

- name: Define clamav_packages.
  set_fact:
    clamav_packages: "{{ __clamav_packages | list }}"
  when: clamav_packages is not defined

- name: Ensure ClamAV packages are installed.
  package: name={{ item }} state=present
  with_items: "{{ clamav_packages }}"
  register: clamav_install

- name: Ensure ClamAV definitions are current.
  command: freshclam
  when: clamav_install.changed or clamav_run_freshclam
  notify: restart clamav daemon

- name: Change configuration for the ClamAV daemon.
  lineinfile:
    path: "{{ clamav_daemon_config_path }}"
    regexp: '{{ item.regexp }}'
    line: "{{ item.line | default('') }}"
    state: "{{ item.state | default('present') }}"
  with_items: "{{ clamav_daemon_configuration_changes }}"

- name: Ensure ClamAV daemon is running (if configured).
  service:
    name: "{{ clamav_daemon }}"
    state: "{{ clamav_daemon_state }}"
    enabled: "{{ clamav_daemon_enabled }}"
